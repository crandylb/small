1       * initsym.s1 -- Initialize Symbol Table, CRB, Feb 26, 2014              
2                                                                               
3       BEGIN INITSYM;                                                          
4       ENT INITSYM;                                                            
5       ENT DMPLIST;                                                            
6       ENT BUFF;                                                               
7       START INIT;                                                             
8                                                                               
9       EXT PROC READ,WRITE;                                                    
10      EXT PROC LEX;                                                           
11      EXT PROC A2B40,B402A;                                                   
12      EXT PROC LOOKS,GETS,GETWRD;                                             
13      EXT PROC IREAD,IFORM,CAT2;                                              
14                                                                              
15      DCL I,J,EOF=0,STATUS;                                                   
16      DCL BUFF(127);                                                          
17      DCL INCH=1,SCRCH=2,OUTCH=3;                                             
18      DCL LEXEME(127);                                                        
19      DCL INDEX,WORDS,KIND,TTYPE,TAG,TAGS,VAL;                                
20      DCL COUNT=0,LIST(60);                                                   
21      DCL STAR=('*');                                                         
22      DCL DOT=('.');                                                          
23      DCL QUOTE=39;                   * ASCII single qoute mark               
24      MSG BLANKS='          ';                                                
25      MSG SCRATCH='          ';                                               
26                                                                              
27      LABEL INIT;                                                             
28        CALL INITSYM;                                                         
29        CALL DMPLIST;                                                         
30      RETURN                                                                  
31                                                                              
32      PROC INITSYM;                                                           
33   1    STATUS=READ(SCRCH,BUFF);      * read first line from chan 2           
34   1    DO WHILE STATUS NE EOF;                                               
35   2      IF BUFF(1) NE STAR;         * skip comment line                     
36   3        THEN                                                              
37   3        I=1;                                                              
38   3        KIND=LEX(I,LEXEME);       * get a symbol                          
39   3        IF LEXEME(1) EQ QUOTE; THEN                                       
40   4            WORDS=LEXEME(2);      * use ASCII code for single character   
41   4            TAGS=1;               * bit for single ASCII character        
42   4          ELSE                                                            
43   4            WORDS=A2B40(LEXEME);  * convert to B40                        
44   4            TAGS=0;               * bit for normal base 40 coding         
45   4          ENDIF                                                           
46   3        KIND=LEX(I,LEXEME);       * get the TTYPE code                    
47   3        J=1;                                                              
48   3        TTYPE=IREAD(J,LEXEME);    * convert to binary                     
49   3        TAG=((TAGS SHL 4) OR TTYPE) SHL 8; * set TTYPE and TAGS bits      
50   3        KIND=LEX(I,LEXEME);       * get VAL for this keyword              
51   3        J=1;                                                              
52   3        VAL=IREAD(J,LEXEME);      * convert to binary                     
53   3        INDEX=LOOKS(WORDS,VAL,TAG);                                       
54   3        COUNT=COUNT+1;                                                    
55   3        LIST(COUNT)=INDEX;        * save INDEX of this keyword            
56   3        ENDIF                                                             
57   2      STATUS=READ(SCRCH,BUFF);    * read next line                        
58   2      ENDDO                                                               
59   1    RETURN                                                                
60   1  ENDPROC                                                                 
61   0                                                                          
62   0  PROC DMPLIST;                                                           
63   1    I=1;                                                                  
64   1    DO WHILE I LE COUNT;                                                  
65   2      INDEX=LIST(I);                                                      
66   2      CALL GETWRD(INDEX,WORDS);   * get coded symbol from table           
67   2      CALL GETS(INDEX,VAL,TAG);   * also get VAL and TAG                  
68   2      TTYPE=TAG SHR 8;            * get the type and TAGS field           
69   2      TAGS=TTYPE SHR 4;           * extract the TAGS bits                 
70   2      TTYPE=TTYPE AND 15;         * isolate the type number               
71   2      BUFF=0;                                                             
72   2      CALL CAT2(BUFF,BLANKS);     * clear BUFF                            
73   2      BUFF=0;                                                             
74   2      IF TAGS AND 1; THEN                                                 
75   3          BUFF(1)=WORDS;          * if single character use ASCII         
76   3        ELSE                                                              
77   3          CALL B402A(WORDS,BUFF); * decode symbol into BUFF               
78   3        ENDIF                                                             
79   2      BUFF=8;                                                             
80   2      CALL IFORM(VAL,SCRATCH);    * insert VAL in BUFF                    
81   2      CALL CAT2(BUFF,SCRATCH);                                            
82   2      SCRATCH=0;                                                          
83   2      CALL CAT2(SCRATCH,BLANKS);                                          
84   2      CALL IFORM(TAG,SCRATCH);    * insert TAG in BUFF                    
85   2      CALL CAT2(BUFF,SCRATCH);                                            
86   2      CALL WRITE(OUTCH,BUFF);                                             
87   2      I=I+1;                                                              
88   2      ENDDO                                                               
89   1    RETURN                                                                
90   1    ENDPROC                                                               
91   0  END                                                                     
 NO ERRORS DETECTED
